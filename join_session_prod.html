<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Session</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

</head>
</head>
<body>
    <div id = "prompt">
        <h1>Enter Your Name</h1>
        <input type="text" id="nameInput" placeholder="Type your name here">
        <h1>Enter Session ID</h1>
        <input type="text" id="sessionIdInput" placeholder="Type session id here">
        <button id = "joinSessionButton">Join Session</button>
    </div>
    <script>
        const socket = io('https://bacarratwinningstracker.onrender.com', {multiplex: false});
        // Listen for success or error messages from the backend
        let sessionId;
        let playerName;
        var leader;
        let intervalId; //used to periodically display and update who has placed their bets. Stops when all bets in
        let fetchIntervalId; // used to fetch and display players in waiting room. Stops when leader starts the game.
        document.getElementById('joinSessionButton').addEventListener('click', () => {
            sessionId = document.getElementById('sessionIdInput').value.trim();
            playerName = document.getElementById('nameInput').value.trim();
            if (!sessionId || !playerName) {
                alert("Please enter both the session ID and your name.");
                return;
            }

            // Emit the 'join' event to the backend
            socket.emit('join', { session_id: sessionId, player_name: playerName });
            socket.off('player_joined');
            socket.on('player_joined', (data) => {
                // Get the prompt container
                const prompt = document.getElementById('prompt');

                // Clear the current content of prompt
                prompt.innerHTML = "";

                // Create and append the "Session Joined Successfully" heading
                const heading = document.createElement('h1');
                heading.textContent = "Session Joined Successfully";
                prompt.appendChild(heading);

                // Create and append the sessionDetails div
                const sessionDetails = document.createElement('div');
                sessionDetails.id = "sessionDetails";
                prompt.appendChild(sessionDetails);

                // Create and append the status paragraph
                const status = document.createElement('p');
                status.id = "status";
                status.innerHTML = "<b>Status:</b> Waiting for leader to start the session...";
                prompt.appendChild(status);

                // Create and append the round paragraph
                const round = document.createElement('p');
                round.id = "round";
                prompt.appendChild(round);

                // Create and append the betamount div
                const betAmount = document.createElement('div');
                betAmount.id = "betamount";
                prompt.appendChild(betAmount);

                // Create and append the displaytable div
                const displayTable = document.createElement('div');
                displayTable.id = "displaytable";

                // Add the heading for the table
                const tableHeading = document.createElement('h2');
                tableHeading.textContent = "Players in Session";
                displayTable.appendChild(tableHeading);

                // Create and append the table
                const table = document.createElement('table');
                table.border = "1";
                table.id = "playersTable";

                // Create and append the table header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                const headerCell = document.createElement('th');
                headerCell.textContent = "Player Name";
                headerRow.appendChild(headerCell);
                thead.appendChild(headerRow);
                table.appendChild(thead);

                // Create and append the table body
                const tbody = document.createElement('tbody');
                table.appendChild(tbody);

                // Append the table to the displayTable div
                displayTable.appendChild(table);

                // Append the displayTable div to the prompt
                prompt.appendChild(displayTable);

                console.log("playersTable created:", document.getElementById("playersTable"));

                fetchLeaderAndUpdateUI();
            });
            // Fetch players initially and every 5 seconds
            setTimeout(fetchPlayers, 0);
            fetchIntervalId = setInterval(fetchPlayers, 2000); // Poll every 2 seconds
        });//end of joinSessionButton logic

        function fetchLeaderAndUpdateUI() {
            axios.post(`https://bacarratwinningstracker.onrender.com/get_leader`, { sessionID: sessionId })
                .then(function (response) {
                    leader = response.data.leader;
                    const sessionDetails = document.getElementById("sessionDetails");
                    sessionDetails.innerHTML = `
                        <p><strong>Leader:</strong> ${leader}</p>
                        <p><strong>Session ID:</strong> ${sessionId}</p>
                    `;
                })
                .catch(function (error) {
                    console.error("Error fetching leader:", error);
                });
        }//end of fetchLeaderAndUpdateUI function. This function fetches and display the sessionId and leader

        function fetchPlayers() {
            axios.post(`https://bacarratwinningstracker.onrender.com/get_players`, { sessionID: sessionId })
                .then(function (response) {
                    const players = response.data.players; // Assume server responds with { players: [{ name, join_time }] }
                    // Always re-query DOM after innerHTML updates
                    const table = document.getElementById("playersTable");
                    if (!table) {
                        console.error("playersTable element not found!");
                        return;
                    }

                    const tableBody = table.getElementsByTagName("tbody")[0];
                    if (!tableBody) {
                        console.error("tbody element not found!");
                        return;
                    }

                    // Clear existing table rows
                    tableBody.innerHTML = "";

                    // Populate table with players
                    players.forEach((player) => {
                        const row = document.createElement("tr");

                        const nameCell = document.createElement("td");
                        nameCell.textContent = player;

                        row.appendChild(nameCell);

                        tableBody.appendChild(row);
                    });
                })
                .catch(function (error) {
                    console.error("Error fetching players:", error);
                });
        }//end of fetchPlayers function

        socket.on('error', (data) => {
            document.getElementById('status').innerText = `Error: ${data.error}`;
        });
            
        socket.on("start_game", (data) => {
            clearInterval(fetchIntervalId);
            console.log("Received start_round event:", data)
            document.getElementById('status').innerHTML = `<b>Status:</b> Session has started!`
            axios.get(`https://bacarratwinningstracker.onrender.com/check_session`).then(response => {
                const round_count = response.data[sessionId]['round_count']
                let round = round_count+1
                document.getElementById('round').innerHTML = `<b>Round:</b> ${round}`
            })
            document.getElementById('betamount').innerHTML = `
                <h1>Enter Your Bet Amount</h1>
                <input type="number" step = ".01" id="betAmount" placeholder="Type bet amount here">
                <button id = "submitBetAmount">Submit Amount</button>
                `
            document.getElementById("submitBetAmount").addEventListener("click", () => {
                
                const submitbut = document.getElementById('submitBetAmount')
                submitbut.disabled=true
                const inputfield = document.getElementById('betAmount')
                inputfield.disabled = true

                socket.emit("place_bet", {
                    session_id: sessionId,
                    player_name: playerName,
                    bet_amount: document.getElementById('betAmount').value
                    });
                    fetchLeaderAndUpdateUI();
                    document.getElementById('betamount').innerHTML+= `<p>Bets submitted successfully!</p>`
                    document.getElementById('displaytable').innerHTML = `
                        <h2>Bets Placed</h2>
                        <table border="1" id="playersTable">
                        <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Current Balance</th>
                                        <th>Bet Amount</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                        </table>
                                `
                    // Start checking
                intervalId = setInterval(periodicCalls, 2000);
                periodicCalls();
            });
        })

        function periodicCalls() {
            displayBets(); // Call endpoint 1 to display data
            fetchCondition()       // Call endpoint 2 to check the condition
                .then(condition => {
                    if (condition) { //condition usually returns false
                        clearInterval(intervalId); // Stop periodic calls
                        console.log("Condition met. Stopping periodic calls.");
                        displayBets(); // Fetch endpoint 1 one last time for display 
                    }
                });
        }//end of periodicCalls function

        function displayBets(){
            return axios.get(`https://bacarratwinningstracker.onrender.com/check_session`) // Replace with your display endpoint
                .then(response => {
                    const players = response.data[sessionId]['players']
                    const bets = response.data[sessionId]['bets']
                    let betsandbalance = {};
                    for (const player in players) {
                        betsandbalance[player] = {
                            balance: players[player],
                            bet_amount: bets[player] !== undefined ? bets[player] : 'NA'
                        };
                    }
                    displayBetsTable(betsandbalance)
                })
                .catch(error => {
                    console.error("Error fetching display data:", error);
                });
        }//end of displayBets function

        function fetchCondition(){
            return axios.get(`https://bacarratwinningstracker.onrender.com/check_bets/${sessionId}`) // Replace with your condition endpoint
                .then(response => response.data['all_bets_in']) // Assuming the response contains { condition: true/false }
                .catch(error => {
                    console.error("Error fetching condition:", error);
                    return false; // Default to false if the request fails
                });
        }//end of fetchCondition function

        function displayBetsTable(bets) {
            const table = document.querySelector('#playersTable');
            let tableBody = table.querySelector('tbody');
            tableBody.innerHTML = '';

            // Populate table rows with bets data
            for (const [player, dets] of Object.entries(bets)) {
                const row = document.createElement('tr');

                const playerCell = document.createElement('td');
                playerCell.textContent = player;

                const balanceCell = document.createElement('td')
                balanceCell.textContent = dets['balance']

                const betCell = document.createElement('td');
                betCell.textContent = dets['bet_amount'];

                row.appendChild(playerCell);
                row.appendChild(balanceCell)
                row.appendChild(betCell);

                tableBody.appendChild(row); // Append the row to the existing table body
            }
        }//end of displayBetsTable function

        socket.on("next_round", (data) => {
            periodicCalls();
        })
                    
        
        </script>
</body>
</html>